generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeviceType {
  mobile
  desktop
  tablet
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  CLOSED
}

enum SheetSyncStatus {
  PENDING
  SUCCESS
  FAILED
  DISABLED
}

model DiagnosticSubmission {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  source                    String          @default("effinity-diagnostic")

  // Idempotency key - prevents duplicate submissions
  clientSubmissionId        String?         @unique

  // User identity
  userIdentifier            String          @default("")
  userDisplayName           String?

  // Client info
  ip                        String?
  country                   String?
  deviceType                DeviceType?
  userAgent                 String?

  // UTM parameters
  utmSource                 String?
  utmMedium                 String?
  utmCampaign               String?
  utmContent                String?
  utmTerm                   String?

  // Questionnaire answers
  q1                        String
  q2                        String
  q3                        String
  q4                        String
  q5                        String
  q6                        String
  q7                        String
  q8                        String
  q9                        String?

  // Computed scores
  chaosScore                Int
  riskLevel                 RiskLevel
  estimatedHoursLostMonthly Int
  estimatedLeakageMin       Int
  estimatedLeakageMax       Int

  // Lead management
  leadEmail                 String?
  leadPhone                 String?
  notes                     String?
  status                    LeadStatus      @default(NEW)

  // Google Sheet sync
  sheetRowId                String?
  sheetSyncStatus           SheetSyncStatus @default(PENDING)
  sheetSyncError            String?
  sheetSyncAttempts         Int             @default(0)
  lastSheetSyncAt           DateTime?

  // Soft delete
  deletedAt                 DateTime?

  // Activity log
  activityLogs              ActivityLog[]

  @@index([createdAt])
  @@index([riskLevel])
  @@index([chaosScore])
  @@index([status])
  @@index([deletedAt])
  @@index([country])
  @@index([deviceType])
  @@index([q8])
  @@index([sheetSyncStatus])
  @@index([clientSubmissionId])
  @@index([userIdentifier])
}

model AdminUser {
  id                    String        @id @default(uuid())
  email                 String        @unique
  passwordHash          String
  name                  String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  lastLoginAt           DateTime?
  isActive              Boolean       @default(true)

  // Security
  mustResetPassword     Boolean       @default(true)
  failedLoginAttempts   Int           @default(0)
  lockedUntil           DateTime?

  // Refresh tokens
  refreshTokens         RefreshToken[]

  // Activity logs
  activityLogs          ActivityLog[]

  @@index([email])
}

model RefreshToken {
  id          String    @id @default(uuid())
  token       String    @unique
  adminId     String
  admin       AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  @@index([token])
  @@index([adminId])
}

model ActivityLog {
  id            String               @id @default(uuid())
  createdAt     DateTime             @default(now())

  // Actor
  adminId       String?
  admin         AdminUser?           @relation(fields: [adminId], references: [id])

  // Target
  submissionId  String?
  submission    DiagnosticSubmission? @relation(fields: [submissionId], references: [id])

  // Action details
  action        String               // e.g., "STATUS_CHANGE", "NOTE_EDIT", "SHEET_SYNC_RETRY"
  details       String?              // JSON string with action details

  @@index([submissionId])
  @@index([adminId])
  @@index([createdAt])
}

model LoginAttempt {
  id          String   @id @default(uuid())
  ip          String
  email       String
  success     Boolean
  createdAt   DateTime @default(now())
  userAgent   String?

  @@index([ip, createdAt])
  @@index([email, createdAt])
}
